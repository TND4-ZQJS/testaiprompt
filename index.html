<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Nomination Form — Web Filler (Baseline: Credit/Debit Card Filler)</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
:root{
  --bg:#f6f7f9; --card:#fff; --accent:#007aff; --muted:#666; --line:#e9e9ee;
}
*{box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial;margin:18px;background:var(--bg);color:#111}
main{max-width:980px;margin:0 auto;background:var(--card);padding:18px;border-radius:12px;box-shadow:0 8px 28px rgba(0,0,0,0.06)}
h1{margin:15px 0 35px 0;font-size:1.50rem}
.section{background:#fbfbfd;border:1px solid #eee;padding:14px;border-radius:10px;margin:12px 0}
.section h2{margin:0 0 10px 0;font-size:1.05rem}
label{display:block;margin:8px 0;font-size:0.95rem}
input[type=text],input[type=email],input[type=number],input[type=tel],select,textarea{
  width:100%;padding:10px;border-radius:10px;border:1px solid #ddd;margin-top:6px;font-size:1rem;background:#fff
}
textarea{min-height:100px;resize:vertical}
.row{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin:8px 0}
.muted{color:var(--muted);font-size:0.85rem}
button{background:var(--accent);color:#fff;border:0;padding:10px 14px;border-radius:10px;cursor:pointer}
button.secondary{background:#999}
button.ghost{background:transparent;border:1px solid var(--line);color:#333}
.actions{display:flex;gap:12px;align-items:center}

/* Policy grid (repeatable) */
.policy-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.policy{background:#fff;padding:12px;border-radius:10px;border:1px solid #eee;position:relative}
.policy h3{margin:0 0 8px 0;font-size:0.95rem;display:flex;align-items:center;justify-content:space-between}
.policy .remove-btn{background:transparent;border:1px solid var(--line);color:#333;border-radius:8px;padding:6px 10px;font-size:0.9rem}
.policy .remove-btn:hover{border-color:#d0d0d7}

/* Signature preview tiles */
.sig-preview{
  width:100%; height:150px; border:1px dashed #bbb; border-radius:10px;
  display:flex; align-items:center; justify-content:center; background:#fff; cursor:pointer; position:relative;
}
.sig-preview img{ max-width:100%; max-height:100%; object-fit:contain; }
.sig-preview span{ color:#999; }

/* Signature Modal */
.sig-modal{ display:none; position:fixed; inset:0; background:rgba(0,0,0,.45); z-index:1000; }
.sig-modal .box{
  width:min(560px, 92vw); background:#fff; margin:6vh auto; padding:14px; border-radius:12px;
  box-shadow:0 18px 50px rgba(0,0,0,.25)
}
.sig-modal h3{ margin:0 0 8px 0; }
/* NOTE: canvas is responsive via CSS; internal pixels are set in JS for crispness */
#sigCanvas{ width:100%; height:220px; background:#fff; border:1px solid #ddd; border-radius:10px; touch-action:none }
.sig-actions{ display:flex; gap:10px; justify-content:flex-end; margin-top:10px; }

/* XY% signature tuning */
.hidden-inputs {display: none;}

/* Save indicator */
#saveStatus{
  position:fixed; bottom:12px; right:12px; background:var(--accent); color:#fff;
  padding:6px 10px; border-radius:8px; font-size:0.85rem; opacity:0; transition:opacity .25s;
}

@media (max-width:900px){ .policy-grid{grid-template-columns:1fr} }
@media (max-width:720px){ }
</style>
</head>
<body>
<main>
  <h1>Nomination Form (Baseline UI/Behavior from Credit/Debit Card Web Filler)</h1>

  <!-- Section: Policy Details (repeatable up to 5) -->
  <section class="section" id="sectionPolicy">
    <h2>Section — Policy Details</h2>
    <div id="policiesContainer" class="policy-grid"></div>
    <div class="row">
      <button id="addPolicy">+ Add Another Policy</button>
      <small class="muted">Repeatable up to 5 entries</small>
    </div>
  </section>

  <!-- Signature Composite Block -->
  <section class="section" id="sectionSignature">
    <h2>Section — Signature</h2>

    <div class="row">
      <label style="flex:1">Name
        <input id="signature_name" type="text" placeholder="FULL NAME">
      </label>
      <label style="flex:1">IC No
        <input id="signature_ic" type="text" placeholder="IC NUMBER">
      </label>
    </div>

    <div class="row">
      <label style="flex:1">State
        <input id="signature_state" type="text" placeholder="STATE">
      </label>
      <label style="flex:1">Date (DD)
        <input id="signature_date" type="number" min="1" max="31" placeholder="DD">
      </label>
      <label style="flex:1">Month
        <input id="signature_month" type="number" min="1" max="12" placeholder="MM">
      </label>
      <label style="flex:1">Year (YYYY)
        <input id="signature_year" type="number" placeholder="YYYY">
      </label>
    </div>

    <label>Signature Pad</label>
    <div id="signature_sig_preview" class="sig-preview" tabindex="0" role="button" aria-label="Tap to draw signature">
      <span>Tap to Sign</span>
    </div>

    <!-- Optional XY/Scale tuning to mimic baseline -->
    <div class="hidden-inputs">
      <label>X (% from left)
        <input id="signature_x" type="number" step="0.1" value="10">
      </label>
      <label>Y (% from bottom)
        <input id="signature_y" type="number" step="0.1" value="10">
      </label>
      <label>Scale (%)
        <input id="signature_scale" type="number" step="1" value="100">
      </label>
    </div>
  </section>

  <!-- Actions -->
  <section class="section">
    <div class="actions">
      <button id="btnExport">Generate PDF</button>
      <button id="btnReset" class="secondary">Reset All</button>
      <button id="btnToggleXY" class="ghost">Toggle XY% Signature Tuning</button>
    </div>
    <small class="muted">PDF Template: not provided. This tool will generate a simple PDF with your entries. If you add a template later, set the filename in JS and fields will map by <code>PDF_MAP</code>.</small>
  </section>

</main>

<!-- Signature Modal -->
<div id="sigModal" class="sig-modal" aria-hidden="true">
  <div class="box">
    <h3>Draw Signature</h3>
    <canvas id="sigCanvas"></canvas>
    <div class="sig-actions">
      <button id="sigUndo" class="ghost">Undo</button>
      <button id="sigClear" class="ghost">Clear</button>
      <button id="sigCancel" class="secondary">Cancel</button>
      <button id="sigDone">Done</button>
    </div>
  </div>
</div>

<div id="saveStatus">Saved</div>

<!-- External libs (same pattern as baseline: loaded from CDN) -->
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js" integrity="sha256-1NqH/F3gpoq1bQ7xwDv2kqFiP4N8LLxP3v3pQ0E3HlU=" crossorigin="anonymous"></script>

<script>
/* =========================
   CONSTANTS & HELPERS
   ========================= */
const NS = 'nomination.'; // localStorage namespace
const MAX_POLICIES = 5;

// Mapping object: HTML id -> PDF field name
const PDF_MAP = {
  // Repeatable Policy Owner Names will be generated as: PO_name_1..5 -> PO_name
  // Signature composite:
  'signature_name': 'signature_name',
  'signature_ic': 'signature_ic',
  'signature_state': 'signature_state',
  'signature_date': 'signature_date',
  'signature_month': 'signature_month',
  'signature_year': 'signature_year',
  // Signature image uses special handling
  'signature_sig': 'signature_sig'
};

// Utility shortcuts
const $ = (id)=>document.getElementById(id);
const el = (tag, props={}, ...children)=>{
  const n=document.createElement(tag); Object.assign(n, props);
  for(const c of children){ if(typeof c==='string') n.appendChild(document.createTextNode(c)); else if(c) n.appendChild(c); }
  return n;
};
const showSaved = ()=>{
  const b = $('saveStatus'); b.style.opacity='1';
  clearTimeout(showSaved._t);
  showSaved._t = setTimeout(()=>b.style.opacity='0', 700);
};
const lsGet = (k, def=null)=>{ try{ const v=localStorage.getItem(NS+k); return v==null?def:JSON.parse(v);}catch(e){return def;} };
const lsSet = (k, v)=>{ localStorage.setItem(NS+k, JSON.stringify(v)); showSaved(); };
const lsDel = (k)=>{ localStorage.removeItem(NS+k); };

/* =========================
   REPEATABLE: POLICY DETAILS
   Each item: textarea id = PO_name_{idx}
   ========================= */
const policiesContainer = $('policiesContainer');
const addPolicyBtn = $('addPolicy');

function renderPolicies(){
  policiesContainer.innerHTML = '';
  const items = lsGet('policies', []);
  items.forEach((item, i)=>{
    const card = el('div', {className:'policy'});
    const title = el('h3', {}, `Policy Detail #${i+1}`, el('button',{className:'remove-btn', onclick:()=>removePolicy(i)},'Remove'));
    const area = el('label', {}, 'Policy owner name',
      el('textarea', {
        id:`PO_name_${i+1}`,
        placeholder:'Enter policy owner name',
        oninput:(e)=>{ items[i] = { name:e.target.value }; lsSet('policies', items); },
        value:item?.name||''
      })
    );
    card.appendChild(title);
    card.appendChild(area);
    policiesContainer.appendChild(card);
  });
}

function addPolicy(){
  const items = lsGet('policies', []);
  if(items.length>=MAX_POLICIES) return alert('You can add up to 5 entries.');
  items.push({name:''});
  lsSet('policies', items);
  renderPolicies();
}
function removePolicy(idx){
  const items = lsGet('policies', []);
  items.splice(idx,1);
  lsSet('policies', items);
  renderPolicies();
}

addPolicyBtn.addEventListener('click', (e)=>{ e.preventDefault(); addPolicy(); });

/* =========================
   AUTOSAVE for simple inputs
   ========================= */
const autosaveIds = ['signature_name','signature_ic','signature_state','signature_date','signature_month','signature_year','signature_x','signature_y','signature_scale'];

function bindAutosave(id){
  const node = $(id);
  if(!node) return;
  // load
  const saved = lsGet(id);
  if(saved!=null) node.value = saved;
  // save
  node.addEventListener('input', ()=> lsSet(id, node.value));
}

autosaveIds.forEach(bindAutosave);

/* =========================
   SIGNATURE PAD (vector paths + PNG)
   ========================= */
const sigModal = $('sigModal');
const sigCanvas = $('sigCanvas');
const sigPreview = $('signature_sig_preview');

let sigCtx, sigPaths=[], sigCurrentPath=null, sigPNG=null;

function openSig(){
  sigModal.style.display='block';
  sigModal.setAttribute('aria-hidden','false');

  // ensure crisp canvas pixels
  const rect = sigCanvas.getBoundingClientRect();
  const dpr = window.devicePixelRatio || 1;
  sigCanvas.width = Math.floor(rect.width * dpr);
  sigCanvas.height = Math.floor(rect.height * dpr);
  sigCtx = sigCanvas.getContext('2d');
  sigCtx.scale(dpr,dpr);
  sigCtx.lineCap='round';
  sigCtx.lineJoin='round';
  sigCtx.lineWidth=2;

  // load existing
  const savedPaths = lsGet('signature_sig_paths', []);
  sigPaths = savedPaths;
  redrawSig();
}

function closeSig(){
  sigModal.style.display='none';
  sigModal.setAttribute('aria-hidden','true');
}

function redrawSig(){
  // clear
  sigCtx.clearRect(0,0,sigCanvas.width, sigCanvas.height);
  sigCtx.save();
  sigCtx.scale((window.devicePixelRatio||1), (window.devicePixelRatio||1)); // maintain correct stroke width after scale
  sigCtx.restore();

  sigCtx.strokeStyle = '#111';
  sigPaths.forEach(path=>{
    if(path.length<2) return;
    sigCtx.beginPath();
    sigCtx.moveTo(path[0].x, path[0].y);
    for(let i=1;i<path.length;i++){ sigCtx.lineTo(path[i].x, path[i].y); }
    sigCtx.stroke();
  });
}

function canvasPoint(evt){
  const rect = sigCanvas.getBoundingClientRect();
  const x = (evt.touches?evt.touches[0].clientX:evt.clientX) - rect.left;
  const y = (evt.touches?evt.touches[0].clientY:evt.clientY) - rect.top;
  return {x,y};
}

function startDraw(evt){
  evt.preventDefault();
  sigCurrentPath = [];
  const p = canvasPoint(evt);
  sigCurrentPath.push(p);
  sigPaths.push(sigCurrentPath);
  redrawSig();
}
function moveDraw(evt){
  if(!sigCurrentPath) return;
  evt.preventDefault();
  const p = canvasPoint(evt);
  sigCurrentPath.push(p);
  redrawSig();
}
function endDraw(evt){
  if(sigCurrentPath && sigCurrentPath.length>0){
    lsSet('signature_sig_paths', sigPaths);
  }
  sigCurrentPath = null;
}

sigCanvas.addEventListener('mousedown', startDraw);
sigCanvas.addEventListener('mousemove', moveDraw);
sigCanvas.addEventListener('mouseup', endDraw);
sigCanvas.addEventListener('mouseleave', endDraw);
sigCanvas.addEventListener('touchstart', startDraw, {passive:false});
sigCanvas.addEventListener('touchmove', moveDraw, {passive:false});
sigCanvas.addEventListener('touchend', endDraw);

$('sigClear').addEventListener('click', ()=>{
  sigPaths = [];
  lsSet('signature_sig_paths', sigPaths);
  redrawSig();
});
$('sigUndo').addEventListener('click', ()=>{
  sigPaths.pop();
  lsSet('signature_sig_paths', sigPaths);
  redrawSig();
});
$('sigCancel').addEventListener('click', ()=>{
  closeSig();
});
$('sigDone').addEventListener('click', ()=>{
  // save PNG preview (CSS pixels)
  const rect = sigCanvas.getBoundingClientRect();
  // draw onto a temporary canvas at CSS pixel resolution
  const tmp = document.createElement('canvas');
  tmp.width = Math.max(1, Math.floor(rect.width));
  tmp.height = Math.max(1, Math.floor(rect.height));
  const tctx = tmp.getContext('2d');
  // redraw paths into tmp
  tctx.lineCap='round'; tctx.lineJoin='round'; tctx.lineWidth=2; tctx.strokeStyle='#111';
  sigPaths.forEach(path=>{
    if(path.length<2) return;
    tctx.beginPath();
    tctx.moveTo(path[0].x, path[0].y);
    for(let i=1;i<path.length;i++){ tctx.lineTo(path[i].x, path[i].y); }
    tctx.stroke();
  });
  sigPNG = tmp.toDataURL('image/png');
  lsSet('signature_sig_png', sigPNG);
  // update preview
  updateSigPreview();
  closeSig();
});

function updateSigPreview(){
  sigPreview.innerHTML='';
  const png = lsGet('signature_sig_png', null);
  if(png){
    const img = new Image();
    img.src = png;
    sigPreview.appendChild(img);
  }else{
    sigPreview.innerHTML = '<span>Tap to Sign</span>';
  }
}

sigPreview.addEventListener('click', openSig);
sigPreview.addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' '){ e.preventDefault(); openSig(); }});

/* =========================
   INIT FROM STORAGE
   ========================= */
function init(){
  if(lsGet('policies')==null){ lsSet('policies', []); }
  renderPolicies();
  updateSigPreview();
}
init();

/* =========================
   RESET
   ========================= */
$('btnReset').addEventListener('click', ()=>{
  if(!confirm('Clear all saved data?')) return;
  // clear namespaced keys
  Object.keys(localStorage).forEach(k=>{ if(k.startsWith(NS)) localStorage.removeItem(k); });
  // reset UI
  init();
  autosaveIds.forEach(id=>{ const n=$(id); if(n) n.value=''; });
  showSaved();
});

/* =========================
   TOGGLE XY% TUNING
   ========================= */
$('btnToggleXY').addEventListener('click', ()=>{
  const wrap = document.querySelector('.hidden-inputs');
  wrap.style.display = (wrap.style.display==='none' || wrap.style.display==='') ? 'block' : 'none';
});

/* =========================
   PDF EXPORT
   - Uses jsPDF to generate a simple PDF
   - If you later provide a template PDF and want to place into it,
     you can adapt this function to use pdf-lib to load & fill fields by PDF_MAP.
   ========================= */
const TEMPLATE_FILENAME = ''; // e.g. 'Nomination_Form_template.pdf' (not provided)

async function generateSimplePDF(){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({unit:'pt', format:'a4'});
  const margin = 48;
  let y = margin;

  doc.setFont('helvetica','bold'); doc.setFontSize(14);
  doc.text('Nomination Form — Generated Output', margin, y); y+=24;

  doc.setFont('helvetica','normal'); doc.setFontSize(11);

  // Policy Details
  doc.text('Section — Policy Details', margin, y); y+=18;
  const policies = lsGet('policies', []);
  if(policies.length===0){
    doc.text('- (no entries)', margin, y); y+=16;
  }else{
    policies.forEach((p, i)=>{
      const txt = `#${i+1} Policy owner name: ${p.name||''}`;
      const lines = doc.splitTextToSize(txt, 520);
      doc.text(lines, margin, y); y+= (lines.length*14)+6;
    });
  }
  y+=6;

  // Signature composite fields
  doc.text('Section — Signature', margin, y); y+=18;
  const pairs = [
    ['Name', $('signature_name').value||''],
    ['IC No', $('signature_ic').value||''],
    ['State', $('signature_state').value||''],
    ['Date', $('signature_date').value||''],
    ['Month', $('signature_month').value||''],
    ['Year', $('signature_year').value||'']
  ];
  pairs.forEach(([k,v])=>{ doc.text(`${k}: ${v}`, margin, y); y+=14; });

  // Signature image
  const sig = lsGet('signature_sig_png', null);
  if(sig){
    y+=6;
    doc.text('Signature:', margin, y); y+=8;
    // place using XY% if provided
    const xPct = parseFloat($('signature_x').value||'10');
    const yPct = parseFloat($('signature_y').value||'10');
    const scalePct = parseFloat($('signature_scale').value||'100');

    // Calculate target size
    const imgW = 300 * (scalePct/100);
    const imgH = 120 * (scalePct/100);

    // Absolute placement using % of page width/height from left/bottom (to mirror baseline feel)
    const pageW = doc.internal.pageSize.getWidth();
    const pageH = doc.internal.pageSize.getHeight();
    const absX = (xPct/100)*pageW;
    const absY_fromBottom = (yPct/100)*pageH;
    const absY = pageH - absY_fromBottom - imgH;

    // Draw a light box showing placement area (debug)
    // doc.setDrawColor(220); doc.rect(absX, absY, imgW, imgH);

    doc.addImage(sig, 'PNG', absX, absY, imgW, imgH);
    y += imgH + 12;
  }

  doc.save('Nomination_Form.pdf');
}

$('btnExport').addEventListener('click', async ()=>{
  // Build dynamic PDF_MAP entries for repeatables (PO_name_1..5 -> PO_name)
  // (kept for compatibility with a future template filler)
  const policies = lsGet('policies', []);
  for(let i=0;i<MAX_POLICIES;i++){
    const key = `PO_name_${i+1}`;
    PDF_MAP[key] = 'PO_name'; // all map to the same field name; template should accept multiple or be indexed
  }
  await generateSimplePDF();
});

/* =========================
   ACCESSIBILITY: Save on unload
   ========================= */
window.addEventListener('beforeunload', ()=>{
  // ensure current simple inputs saved
  autosaveIds.forEach(id=>{ const n=$(id); if(n) lsSet(id, n.value); });
});

</script>
</body>
</html>
